"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var child_process_1 = require("child_process");
var sdtin_write_1 = require("./sdtin-write");
var stream_to_string_1 = require("./stream-to-string");
function execute(cmd) {
    var args = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        args[_i - 1] = arguments[_i];
    }
    var timeout = 3000;
    var stdin = '';
    return new Promise(function (res, rej) {
        var p;
        if (args[0] && args[0] instanceof Array) {
            p = child_process_1.spawn(cmd, args[0]);
            if (args[1] && typeof args[1] === 'object') {
                timeout = args[1] && args[1].timeout || timeout;
                stdin = args[1] && args[1].stdin || stdin;
            }
        }
        else if (args[0] && typeof args[0] === 'object') {
            p = child_process_1.spawn(cmd);
            timeout = args[0] && args[0].timeout || timeout;
            stdin = args[0] && args[0].stdin || stdin;
        }
        else {
            p = child_process_1.spawn(cmd);
        }
        //write to stdin
        sdtin_write_1.writeToStdin(p, stdin);
        var killTimerId = setTimeout(function () {
            p.kill();
        }, timeout);
        var resultPromise = [];
        resultPromise.push((stream_to_string_1.streamDataToString(p.stderr)));
        resultPromise.push(stream_to_string_1.streamDataToString(p.stdout));
        var pr = Promise.all(resultPromise);
        p.on('close', function (exitCode) {
            pr
                .then(function (result) {
                clearTimeout(killTimerId);
                return result;
            })
                .then(function (result) { return ({
                stderr: result[0],
                stdout: result[1],
                exitCode: exitCode
            }); })
                .then(function (result) { return res(result); })
                .catch(function (err) {
                clearTimeout(killTimerId);
                rej(err);
            });
        });
    });
}
exports.execute = execute;
//# sourceMappingURL=execute-command.js.map